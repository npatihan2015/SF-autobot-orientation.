<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SanFun Group — Optimus Prime Assembly</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--red:#e60000;--blue:#0044cc;--gold:#ffcc00;--cyan:#00ffff;--green:#00ff66;--dark:#02050a;--panel:rgba(2,6,12,0.85);--border:rgba(0,255,255,0.25);--text:#8ab4f8;--bright:#ffffff}
html,body{width:100%;height:100%;overflow:hidden;background:var(--dark);user-select:none;font-family:'Rajdhani',sans-serif;color:var(--text)}
#c{position:fixed;inset:0;width:100%;height:100%;display:block;cursor:crosshair}

.vignette{position:fixed;inset:0;pointer-events:none;z-index:4;background:radial-gradient(circle at center,transparent 20%,rgba(0,2,5,0.8) 100%)}

/* HUD STRUCTURE */
.hud-top{position:fixed;top:0;left:0;right:0;z-index:20;display:flex;align-items:center;justify-content:space-between;padding:15px 30px;background:linear-gradient(180deg,rgba(0,5,12,.95) 0%,transparent 100%);border-bottom:1px solid rgba(0,255,255,0.15)}
.logo-block{display:flex;align-items:center;gap:15px}
.logo-icon{width:40px;height:40px;border:1px solid var(--cyan);display:flex;align-items:center;justify-content:center;box-shadow:0 0 15px rgba(0,255,255,.2); position:relative}
.logo-icon::after{content:'';position:absolute;inset:-4px;border:1px solid rgba(0,255,255,0.5);border-radius:2px;animation:spin 10s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.logo-icon svg{width:22px;height:22px; filter:drop-shadow(0 0 5px var(--cyan))}
.t1{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:900;color:var(--bright);letter-spacing:5px; text-shadow:0 0 10px rgba(255,255,255,0.3)}
.t2{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--cyan);letter-spacing:4px;opacity:.8}

/* PANELS */
.panel{position:fixed;top:85px;width:320px;z-index:20;display:flex;flex-direction:column;gap:12px;}
.panel-l{left:30px;bottom:70px;overflow-y:auto;scrollbar-width:none}
.panel-l::-webkit-scrollbar{display:none}
.panel-r{right:30px;transition:all 0.8s cubic-bezier(0.16, 1, 0.3, 1);opacity:0.05;pointer-events:none;transform:translateX(40px)}
.panel-r.unlocked{opacity:1;pointer-events:auto;transform:translateX(0)}

.card{background:var(--panel);border:1px solid var(--border);padding:18px;position:relative;backdrop-filter:blur(20px);box-shadow:inset 0 0 20px rgba(0,255,255,0.02), 0 10px 30px rgba(0,0,0,0.5);border-radius:4px;}
.card::before{content:'';position:absolute;top:0;left:0;width:30px;height:2px;background:var(--cyan);box-shadow:0 0 10px var(--cyan)}
.card::after{content:'';position:absolute;bottom:0;right:0;width:30px;height:2px;background:var(--cyan);box-shadow:0 0 10px var(--cyan)}
.ct{font-family:'Orbitron',sans-serif;font-size:10px;font-weight:700;color:var(--cyan);letter-spacing:4px;margin-bottom:15px;display:flex;align-items:center;gap:10px}
.ct::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)}

/* SEQUENCE ITEMS */
#stages-container{display:flex;flex-direction:column;gap:8px;}
.si{display:flex;flex-direction:column;padding:12px;border:1px solid rgba(255,255,255,0.05);transition:all .4s cubic-bezier(0.16, 1, 0.3, 1);position:relative;background:rgba(0,0,0,0.4);border-radius:2px;overflow:hidden}
.si::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;transition:background .4s}
.si.done::before{background:var(--cyan)}.si.act::before{background:var(--gold)}.si.lck::before{background:#1a2535}
.si.done{border-color:rgba(0,255,255,.2);background:linear-gradient(90deg, rgba(0,255,255,.05), transparent)}
.si.act{border-color:rgba(255,204,0,.5);background:linear-gradient(90deg, rgba(255,204,0,.1), transparent);transform:translateX(5px);box-shadow: -5px 0 15px rgba(255,204,0,0.15)}
.si.lck{opacity:.3}
.si-header{display:flex;align-items:center;gap:12px;}
.sn{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:900;width:22px;text-align:center;text-shadow:0 0 10px currentColor}
.si.done .sn{color:var(--cyan)}.si.act .sn{color:var(--gold)}.si.lck .sn{color:#3a4a60}
.si-info .sname{font-size:13px;font-weight:700;color:var(--bright);letter-spacing:2px}.si-info .ssub{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text);opacity:.7;letter-spacing:1px}
.install-btn{margin-top:12px;padding:10px;background:var(--gold);color:#000;border:none;font-family:'Orbitron',sans-serif;font-size:10px;font-weight:900;letter-spacing:3px;cursor:pointer;transition:all 0.3s;display:none;text-align:center;box-shadow:0 0 15px rgba(255,204,0,0.4);clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);}
.si.act .install-btn{display:block}
.install-btn:hover{background:#ffdd33;box-shadow:0 0 25px rgba(255,204,0,0.8);transform:scale(1.02)}

/* PROGRESS BAR */
.pb-wrap{margin-top:15px}.pb-lbl{display:flex;justify-content:space-between;margin-bottom:8px}
.pb-lbl span{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px}
.pbl{color:var(--cyan);opacity:.8}.pbv{color:var(--bright);font-weight:700;text-shadow:0 0 5px var(--cyan)}
.pb{height:4px;background:rgba(255,255,255,.05);border-radius:2px;overflow:hidden;position:relative}
.pbf{height:100%;width:0%;background:var(--cyan);box-shadow:0 0 15px var(--cyan);transition:width 0.8s cubic-bezier(0.16, 1, 0.3, 1)}

/* RIGHT PANEL SPECS */
.sr{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.03)}
.sk{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text);opacity:.7;letter-spacing:1px}
.sv{font-family:'Share Tech Mono',monospace;font-size:10px;font-weight:700;letter-spacing:1px}
.sv.c{color:var(--cyan); text-shadow: 0 0 8px rgba(0,255,255,0.5)}.sv.a{color:var(--gold); text-shadow: 0 0 8px rgba(255,204,0,0.5)}.sv.g{color:var(--green); text-shadow: 0 0 8px rgba(0,255,102,0.5)}.sv.r{color:var(--red); text-shadow: 0 0 8px rgba(230,0,0,0.5)}

/* ACTION GRID */
.abg{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:5px}
.ab{padding:10px 5px;font-family:'Orbitron',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;text-align:center;border:1px solid var(--border);background:rgba(0,255,255,.02);color:var(--text);cursor:pointer;transition:all .2s;clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);}
.ab:hover{border-color:var(--cyan);color:var(--bright);background:rgba(0,255,255,.15);box-shadow:0 0 15px rgba(0,255,255,.3)}
.ab.on{border-color:var(--gold);color:#000;background:var(--gold);box-shadow:0 0 20px rgba(255,204,0,.4)}

/* HUD BOT */
.hud-bot{position:fixed;bottom:0;left:0;right:0;z-index:20;padding:12px 30px;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(0deg,rgba(0,5,12,.95) 0%,transparent 100%);border-top:1px solid rgba(0,255,255,0.15)}
.hb-left, .hb-right{display:flex;align-items:center;gap:30px}
.hs{display:flex;flex-direction:column}
.hs .val{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:900;color:var(--bright);line-height:1;text-shadow:0 0 10px rgba(255,255,255,0.2)}
.hs .lbl{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--cyan);opacity:.6;letter-spacing:3px;margin-top:4px}
.status-pill{display:flex;align-items:center;gap:8px;font-family:'Orbitron',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;padding:6px 12px;border:1px solid var(--border);background:rgba(0,255,255,.05);clip-path: polygon(8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%, 0 8px);}
.dot{width:6px;height:6px;border-radius:50%;}
.dot.a{background:var(--gold);box-shadow:0 0 8px var(--gold);animation:blink 1s infinite}
.dot.g{background:var(--green);box-shadow:0 0 8px var(--green)}
@keyframes blink{50%{opacity:0.3}}

/* TASK MODAL */
#task-modal {position:fixed;inset:0;background:rgba(0,2,5,0.9);z-index:50;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.4s;backdrop-filter:blur(15px);}
#task-modal.show {opacity:1;pointer-events:auto;}
.tm-box {width:600px;max-width:90%;background:rgba(2,6,12,0.9);border:1px solid var(--cyan);box-shadow:0 0 50px rgba(0,255,255,0.15), inset 0 0 30px rgba(0,255,255,0.05);padding:40px;position:relative;transform:scale(0.95) translateY(20px);transition:all 0.4s cubic-bezier(0.16, 1, 0.3, 1);}
#task-modal.show .tm-box {transform:scale(1) translateY(0);}
.tm-box::before {content:'';position:absolute;top:0;left:0;width:100%;height:3px;background:var(--cyan);box-shadow:0 0 20px var(--cyan)}
.tm-header {display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(0,255,255,0.2);padding-bottom:15px;margin-bottom:25px;}
.tm-title {font-family:'Orbitron',sans-serif;color:var(--bright);font-size:22px;font-weight:900;letter-spacing:4px;text-shadow:0 0 15px var(--cyan)}
.tm-close {color:var(--text);cursor:pointer;font-family:monospace;font-size:28px;transition:color 0.2s;}
.tm-close:hover {color:var(--red);text-shadow:0 0 10px var(--red)}
.tm-content {font-size:16px;line-height:1.8;color:var(--text);margin-bottom:35px;max-height:50vh;overflow-y:auto;padding-right:15px;}
.tm-content b{color:var(--bright);font-family:'Orbitron',sans-serif;letter-spacing:1px;font-size:18px}
.tm-content::-webkit-scrollbar {width:4px;}
.tm-content::-webkit-scrollbar-thumb {background:var(--cyan);}
.tm-btn {background:var(--cyan);color:#000;border:none;padding:16px 20px;font-family:'Orbitron',sans-serif;font-size:14px;font-weight:900;letter-spacing:4px;cursor:pointer;width:100%;transition:all 0.3s;box-shadow:0 0 20px rgba(0,255,255,0.3);clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);}
.tm-btn:hover {background:var(--bright);box-shadow:0 0 30px rgba(255,255,255,0.8);transform:translateY(-2px)}

/* GREETING MODAL & FLASH */
#greeting {position:fixed;top:45%;left:50%;transform:translate(-50%,-50%) scale(0.8);text-align:center;opacity:0;pointer-events:none;transition:all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);z-index:100;}
#greeting.show {opacity:1;transform:translate(-50%,-50%) scale(1);}
#greeting .title {font-family:'Orbitron',sans-serif;font-size:50px;font-weight:900;color:var(--bright);margin-bottom:15px;letter-spacing:8px;text-shadow:0 0 30px var(--cyan), 0 0 10px var(--bright)}
#greeting .sub {font-family:'Share Tech Mono',monospace;font-size:18px;letter-spacing:6px;color:var(--cyan);text-transform:uppercase}
#flash{position:fixed;inset:0;background:var(--bright);z-index:90;opacity:0;pointer-events:none;transition:opacity 0.5s ease-out;mix-blend-mode:overlay}

/* LOADER */
#loader{position:fixed;inset:0;z-index:100;background:var(--dark);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;transition:opacity 0.8s ease-in-out}
.ll{font-family:'Orbitron',sans-serif;font-size:40px;font-weight:900;color:var(--bright);letter-spacing:12px;text-shadow:0 0 30px rgba(0,255,255,0.5)}
.ll span{color:var(--cyan)}
.lbw{width:300px;height:2px;background:rgba(255,255,255,.1);position:relative;overflow:hidden}
.lb{height:100%;width:0;background:var(--cyan);box-shadow:0 0 15px var(--cyan);transition:width .1s linear}
.lm{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text);letter-spacing:4px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:.5}50%{opacity:1}}
</style>
</head>
<body>
<div id="loader">
  <div class="ll">PRIME<span>INIT</span></div>
  <div class="lbw"><div class="lb" id="lb"></div></div>
  <div class="lm" id="lm">LOADING GLTF ASSETS...</div>
</div>

<div id="flash"></div>

<div id="task-modal">
  <div class="tm-box">
    <div class="tm-header">
      <div class="tm-title" id="tm-title">MODULE</div>
      <div class="tm-close" onclick="closeTask()">✕</div>
    </div>
    <div class="tm-content" id="tm-content">...</div>
    <button class="tm-btn" id="tm-btn" onclick="completeTask()">INITIATE SEQUENCE</button>
  </div>
</div>

<div id="greeting">
   <div class="title">PRIME AWAKENED</div>
   <div class="sub">Autobots, Roll Out! Welcome to SanFun Group.</div>
</div>

<canvas id="c"></canvas>
<div class="vignette"></div>

<header class="hud-top">
  <div class="logo-block">
    <div class="logo-icon">
      <svg viewBox="0 0 20 20" fill="none"><polygon points="10,2 17,6 17,14 10,18 3,14 3,6" stroke="#00ffff" stroke-width="1.5" fill="rgba(0,255,255,.1)"/><circle cx="10" cy="10" r="3" fill="#00ffff"/></svg>
    </div>
    <div><div class="t1">OPTIMUS PRIME PROTOCOL</div><div class="t2">HANGAR BAY 04 — LEADER CLASS ASSEMBLY</div></div>
  </div>
  <button onclick="resetProgress()" style="background:transparent; border:1px solid var(--border); color:var(--text); font-family:'Orbitron',sans-serif; font-size:9px; font-weight:700; letter-spacing:2px; padding:8px 15px; cursor:pointer; transition:all 0.3s">SYSTEM RESET</button>
</header>

<div class="panel panel-l">
  <div class="card">
    <div class="ct">CONSTRUCTION PROTOCOL</div>
    <div id="stages-container"></div>
    <div class="pb-wrap">
      <div class="pb-lbl"><span class="pbl">OVERALL INTEGRATION</span><span class="pbv" id="pb-val">0%</span></div>
      <div class="pb"><div class="pbf" id="pb-fill"></div></div>
    </div>
  </div>
</div>

<div class="panel panel-r" id="panel-controls">
  <div class="card">
    <div class="ct">NEURAL OVERRIDE</div>
    <div class="abg">
      <button class="ab on"  id="btn-idle"    onclick="setAnim('idle')">STANDBY</button>
      <button class="ab"     id="btn-march"   onclick="setAnim('walk')">ROLL OUT</button>
      <button class="ab"     id="btn-wave"    onclick="setAnim('attack')">COMBAT</button>
      <button class="ab"     id="btn-punch"   onclick="setAnim('run')">SPRINT</button>
    </div>
  </div>
  <div class="card">
    <div class="ct">TELEMETRY DATA</div>
    <div class="sr"><span class="sk">CORE TEMP</span><span class="sv c" id="ltemp">3200 K</span></div>
    <div class="sr"><span class="sk">ANIMATION</span><span class="sv c" id="lanim">IDLE</span></div>
    <div class="sr"><span class="sk">REACTOR</span><span class="sv g" id="lt-power">NOMINAL</span></div>
    <div class="sr"><span class="sk">OVERDRIVE</span><span class="sv c" id="lt-trans">STANDBY</span></div>
  </div>
</div>

<div class="hud-bot">
  <div class="hb-left">
    <div class="status-pill"><div class="dot a" id="sys-dot"></div><span id="sys-txt" style="color:var(--gold)">ASSEMBLING</span></div>
    <div class="hs"><div class="val" id="b-stage">0<span>/7</span></div><div class="lbl">MODULES</div></div>
  </div>
  <div class="hb-center" style="text-align:center">
     <div style="font-family:'Orbitron',sans-serif;font-size:12px;font-weight:900;letter-spacing:5px;color:var(--bright);margin-bottom:5px" id="b-msg">AWAITING PILOT INPUT</div>
     <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--cyan);opacity:0.6;letter-spacing:2px">W A S D TO MOVE • MOUSE TO LOOK</div>
  </div>
  <div class="hb-right">
     <div class="hs" style="text-align:right"><div class="val" id="ltime">00:00</div><div class="lbl">MISSION TIMER</div></div>
  </div>
</div>

<!-- DEPENDENCIES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

<script>
/* ======================================================================
   CUSTOM GLB/GLTF LOADER ENABLED FOR OPTIMUS PRIME
====================================================================== */
const USE_CUSTOM_GLTF = true;

/* ── AUDIO ENGINE ── */
const Snd = {
  ctx: null,
  init: function() { if(!this.ctx){this.ctx = new (window.AudioContext || window.webkitAudioContext)();} if(this.ctx.state==='suspended')this.ctx.resume(); },
  play: function(f, t, d, v, slide=false) {
    if(!this.ctx) return;
    const o = this.ctx.createOscillator(), g = this.ctx.createGain();
    o.type = t; o.frequency.setValueAtTime(f, this.ctx.currentTime);
    if(slide) o.frequency.exponentialRampToValueAtTime(f/2, this.ctx.currentTime + d);
    g.gain.setValueAtTime(v, this.ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + d);
    o.connect(g); g.connect(this.ctx.destination);
    o.start(); o.stop(this.ctx.currentTime + d);
  },
  ui: () => Snd.play(1200, 'sine', 0.1, 0.1),
  heavySnap: () => {
    Snd.play(80, 'square', 0.3, 0.4, true);
    setTimeout(()=>Snd.play(150, 'sawtooth', 0.4, 0.3, true), 100);
    setTimeout(()=>Snd.play(40, 'square', 0.5, 0.5, true), 150);
  },
  surge: () => {
    if(!Snd.ctx) return;
    const o=Snd.ctx.createOscillator(), g=Snd.ctx.createGain();
    o.type='sawtooth'; o.frequency.setValueAtTime(30, Snd.ctx.currentTime); o.frequency.exponentialRampToValueAtTime(800, Snd.ctx.currentTime+3);
    g.gain.setValueAtTime(0, Snd.ctx.currentTime); g.gain.linearRampToValueAtTime(0.3, Snd.ctx.currentTime+2); g.gain.linearRampToValueAtTime(0, Snd.ctx.currentTime+4);
    o.connect(g); g.connect(Snd.ctx.destination); o.start(); o.stop(Snd.ctx.currentTime+4);
  }
};
document.addEventListener('click', () => Snd.init(), {once:true});

/* ── DATA ── */
const STAGES = [
  { id: 1, name: 'LOWER SERVOS', sub: 'Structural Foundation', action: 'DEPLOY LEGS', content: `<b>Initiating SanFun Protocol</b><br><br>Commitment to core principles is required before materialization.<br><br>1. Innovate relentlessly.<br>2. Support the grid.<br>3. Exceed limitations.<br><br>Confirm identity to initialize the lower structure.` },
  { id: 2, name: 'PELVIS & CORE', sub: 'Energy Matrix', action: 'MOUNT REACTOR', content: `<b>Energy Matrix Requirements</b><br><br>The Leader Class requires standard power verification. You must authorize the internal sequence.<br><br>• Security protocols synced.<br>• 2FA Biometrics confirmed.<br><br>Authorize integration.` },
  { id: 3, name: 'LOWER CHEST', sub: 'Mobility Array', action: 'ATTACH ARMOR', content: `<b>Kinetic Dampeners</b><br><br>The sheer weight of the armor requires heavy kinetic dampeners.<br><br>• Calibrating gyro-stabilizers.<br>• Syncing workspace coordinates.<br><br>Engage hydraulic locks to attach armor array.` },
  { id: 4, name: 'UPPER CHEST', sub: 'Engine Block', action: 'SEAL CHEST', content: `<b>Engine Block Synchronization</b><br><br>Locking the main chest cavity. This protects the Matrix of Leadership.<br><br>• Compiling toolchains.<br>• Loading Docker containers.<br><br>Lock servos in place.` },
  { id: 5, name: 'MANIPULATORS', sub: 'Heavy Arms', action: 'MOUNT ARMS', content: `<b>Tactical Manipulators</b><br><br>Equipping dual heavy-lift manipulator arms. These are required for high-level IDE operations.<br><br>• Establishing Mentor comms-link.<br>• Mapping organizational grid.<br><br>Connect the arms.` },
  { id: 6, name: 'SHOULDER PADS', sub: 'Weapon Systems', action: 'ATTACH PAULDRONS', content: `<b>Weapon Systems</b><br><br>Heavy shoulder pauldrons required for defensive capabilities.<br><br>• Firewalls active.<br>• Zero-trust architecture verified.<br><br>Insert the defensive processor.` },
  { id: 7, name: 'THE MATRIX', sub: 'Full Awakening', action: 'AWAKEN PRIME', content: `<b>Total System Override</b><br><br>All physical systems are locked. Hardware is primed.<br><br>By initiating the awakening, you will assume direct manual control of Optimus Prime.<br><br>Prepare for full sensory integration.` }
];

let currentStage = parseInt(localStorage.getItem('sf_optimus_stage')) || 1;
let isFullyAssembled = false;
let activeTaskId = null;
const keys = { w:false, a:false, s:false, d:false, shift:false };
let mouseX = 0, mouseY = 0;

function saveProgress(s){ localStorage.setItem('sf_optimus_stage', s); }
window.resetProgress = () => { localStorage.removeItem('sf_optimus_stage'); location.reload(); }

/* ── UI GEN ── */
function renderUI() {
  const c = document.getElementById('stages-container'); c.innerHTML = '';
  STAGES.forEach(st => {
    let cls = 'lck', bdg = 'LOCKED';
    if(st.id < currentStage) { cls = 'done'; bdg = 'INTEGRATED'; } 
    else if(st.id === currentStage) { cls = 'act'; bdg = 'REQUIRED'; }
    c.innerHTML += `<div class="si ${cls}"><div class="si-header"><div class="sn">0${st.id}</div><div class="si-info"><div class="sname">${st.name}</div><div class="ssub">${st.sub}</div></div><div class="sbadge">${bdg}</div></div><button class="install-btn" onclick="openTask(${st.id})">${st.action}</button></div>`;
  });
  const pct = Math.floor(((currentStage - 1) / 7) * 100);
  const pbVal = document.getElementById('pb-val');
  if(pbVal) pbVal.textContent = pct + '%';
  const pbFill = document.getElementById('pb-fill');
  if(pbFill) pbFill.style.width = pct + '%';
  const bStage = document.getElementById('b-stage');
  if(bStage) bStage.innerHTML = `${Math.min(currentStage - 1, 7)}<span>/7</span>`;
}

window.openTask = (id) => {
  if(id !== currentStage || isFullyAssembled) return;
  Snd.ui(); activeTaskId = id;
  const s = STAGES[id-1];
  document.getElementById('tm-title').textContent = `DIRECTIVE 0${id}`;
  document.getElementById('tm-content').innerHTML = s.content;
  document.getElementById('tm-btn').textContent = s.action;
  document.getElementById('task-modal').classList.add('show');
}
window.closeTask = () => { Snd.ui(); document.getElementById('task-modal').classList.remove('show'); activeTaskId=null; }
window.completeTask = () => { if(!activeTaskId)return; const id=activeTaskId; closeTask(); setTimeout(()=>triggerInstall(id), 400); }

/* ── 3D ENGINE ── */
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:false});
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.0; 

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x02050a);
scene.fog = new THREE.FogExp2(0x02050a, 0.02);

const cam = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 300);
cam.position.set(0, 4, 18);

// POST PROCESSING (Bloom)
const renderScene = new THREE.RenderPass(scene, cam);
const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 0.4, 0.6, 0.85); 
bloomPass.threshold = 0.6; 
bloomPass.strength = 0.4; 
bloomPass.radius = 0.4;
const composer = new THREE.EffectComposer(renderer);
composer.addPass(renderScene);
composer.addPass(bloomPass);

// LIGHTS
scene.add(new THREE.AmbientLight(0x0a1526, 2.5));
const sun = new THREE.DirectionalLight(0xffffff, 1.5); 
sun.position.set(8, 20, 10); sun.castShadow = true;
sun.shadow.mapSize.set(2048, 2048);
sun.shadow.camera.near = 1; sun.shadow.camera.far = 60;
sun.shadow.camera.left=-15; sun.shadow.camera.right=15; sun.shadow.camera.top=15; sun.shadow.camera.bottom=-15;
sun.shadow.bias = -0.001;
scene.add(sun);

const cR = new THREE.PointLight(0x00ffff, 0, 25); cR.position.set(-7,5,-2); scene.add(cR);
const rR = new THREE.PointLight(0xff0033, 0, 20); rR.position.set(6,4,-4); scene.add(rR);

/* ── AUTO-ASSEMBLY GLTF LOADER WITH FALLBACK ── */
const robot = new THREE.Group(); scene.add(robot);

let mixer;
let gltfAnimations = [];
let customModelChunks = [];
let customModelRoot;

if(USE_CUSTOM_GLTF) {
  const manager = new THREE.LoadingManager();
  const customLoader = new THREE.GLTFLoader(manager);

  async function loadOptimusModel() {
    try {
      // ตั้งค่า URL เริ่มต้นสำหรับการโฮสต์บนเครื่องหรือ GitHub
      let gltfUrl = "./scene.gltf";
      
      // ตรวจสอบว่ากำลังรันในหน้า Preview ของ AI Chat
      const isPreview = window.location.protocol === 'blob:' || window.location.hostname.includes('usercontent');
      
      if (isPreview) {
          const lmEl = document.getElementById('lm');
          if(lmEl) lmEl.textContent = "FETCHING PREVIEW ASSETS...";
          
          try {
              // พยายามดึงไฟล์ที่จำลองอยู่ในหน้าต่างแชท (Uploaded files)
              const [gltfRes, binRes, tex1Res, tex2Res] = await Promise.all([
                  fetch("uploaded:optimus_prime_rotf_dotm_animation.zip/scene.gltf"),
                  fetch("uploaded:optimus_prime_rotf_dotm_animation.zip/scene.bin"),
                  fetch("uploaded:optimus_prime_rotf_dotm_animation.zip/textures/RB_Optimus_MATINST_baseColor.jpeg"),
                  fetch("uploaded:optimus_prime_rotf_dotm_animation.zip/textures/RB_OptimusHead_MATINST_baseColor.jpeg")
              ]);

              if (!gltfRes.ok || !binRes.ok) throw new Error("Fetch Uploaded Failed");

              const gltfBlobUrl = URL.createObjectURL(await gltfRes.blob());
              const binBlobUrl = URL.createObjectURL(await binRes.blob());
              const tex1BlobUrl = URL.createObjectURL(await tex1Res.blob());
              const tex2BlobUrl = URL.createObjectURL(await tex2Res.blob());

              gltfUrl = gltfBlobUrl;
              
              manager.setURLModifier((url) => {
                  if (url.includes('scene.bin')) return binBlobUrl;
                  if (url.includes('RB_Optimus_MATINST_baseColor.jpeg')) return tex1BlobUrl;
                  if (url.includes('RB_OptimusHead_MATINST_baseColor.jpeg')) return tex2BlobUrl;
                  return url;
              });
          } catch (fetchError) {
              console.warn("ระบบดึงไฟล์จำลองล้มเหลว กำลังสลับไปดึงจาก GitHub...", fetchError);
              // Fallback: ถ้าระบบจำลองบล็อก ให้ไปดึงจาก GitHub ของคุณโดยตรง
              const baseUrl = "https://raw.githubusercontent.com/npatihan2015/SF-autobot-orientation/main/";
              gltfUrl = baseUrl + "scene.gltf";
              
              manager.setURLModifier((url) => {
                  if (url.includes('scene.bin')) return baseUrl + "scene.bin";
                  if (url.includes('RB_Optimus_MATINST_baseColor.jpeg')) return baseUrl + "textures/RB_Optimus_MATINST_baseColor.jpeg";
                  if (url.includes('RB_OptimusHead_MATINST_baseColor.jpeg')) return baseUrl + "textures/RB_OptimusHead_MATINST_baseColor.jpeg";
                  return url;
              });
          }
      }

      const lmEl = document.getElementById('lm');
      if(lmEl) lmEl.textContent = "BUILDING MESHES...";

      customLoader.load(gltfUrl, function(gltf) {
        customModelRoot = gltf.scene;
        
        // Auto-Scale Optimus to fit the hangar perfectly
        const box = new THREE.Box3().setFromObject(customModelRoot);
        const size = box.getSize(new THREE.Vector3()).length();
        const scaleFactor = 10 / size; // Scale to ~10 units
        customModelRoot.scale.setScalar(scaleFactor);
        
        // Adjust Y position so feet touch the floor
        box.setFromObject(customModelRoot);
        customModelRoot.position.y += (-box.min.y - 1.4); 

        // Enable Animations if any exist
        if(gltf.animations && gltf.animations.length > 0) {
          mixer = new THREE.AnimationMixer(customModelRoot);
          gltfAnimations = gltf.animations;
        }

        let meshes = [];
        customModelRoot.traverse((node) => {
          if (node.isMesh) {
            node.castShadow = true;
            node.receiveShadow = true;
            // Boost material realism
            if(node.material) {
               node.material.metalness = 0.8;
               node.material.roughness = 0.3;
            }
            
            // Calculate the height (Y) of each mesh to sort them bottom-to-top
            node.geometry.computeBoundingBox();
            let center = new THREE.Vector3();
            node.geometry.boundingBox.getCenter(center);
            node.localToWorld(center);
            meshes.push({mesh: node, y: center.y});
            node.visible = false; // Hide all meshes initially for assembly
          }
        });

        // Sort meshes by Height (Y axis) ascending
        meshes.sort((a,b) => a.y - b.y);

        // Group sorted meshes into 7 exact stages automatically!
        const numStages = 7;
        const chunkSize = Math.ceil(meshes.length / numStages);
        for(let i=0; i<numStages; i++) {
          customModelChunks.push(meshes.slice(i*chunkSize, (i+1)*chunkSize).map(m => m.mesh));
        }

        // Reveal already completed stages instantly (loaded from local storage)
        for(let i=1; i<currentStage; i++) {
           if(customModelChunks[i-1]) {
             customModelChunks[i-1].forEach(m => m.visible = true);
           }
        }

        robot.add(customModelRoot);
        
        // เมื่อโหลดเสร็จแล้ว ให้ซ่อน Loading screen
        const ldr = document.getElementById('loader');
        if (ldr) {
            ldr.style.opacity = 0;
            setTimeout(() => ldr.style.display = 'none', 800);
        }
        
      }, undefined, function (error) {
        console.error("GLTF Load Error:", error);
        const errEl = document.getElementById('lm');
        if (errEl) {
            errEl.innerHTML = "ไม่สามารถเชื่อมต่อโมเดลได้<br/>ลองรันบน GitHub โดยตรงครับ";
            errEl.style.color = "red";
        }
      });
      
    } catch (e) {
      console.error("Critical Load Error", e);
    }
  }
  
  loadOptimusModel();
}

/* ── IMMERSIVE HANGAR BAY ── */
// Heavy Metallic Floor
const floorM = new THREE.MeshStandardMaterial({color:0x111520, metalness:0.8, roughness:0.2});
const floor = new THREE.Mesh(new THREE.PlaneGeometry(60,60), floorM);
floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; scene.add(floor);
const grid = new THREE.GridHelper(60, 60, 0x00e5ff, 0x050a15);
grid.material.opacity = 0.15; grid.material.transparent = true; grid.position.y = 0.01; scene.add(grid);

// Launchpad Ring
const padR = new THREE.Mesh(new THREE.RingGeometry(2.8, 3.0, 64), new THREE.MeshBasicMaterial({color:0x00e5ff, side:THREE.DoubleSide}));
padR.rotation.x = -Math.PI/2; padR.position.y = 0.02; scene.add(padR);
const padGlow = new THREE.Mesh(new THREE.CircleGeometry(2.8, 64), new THREE.MeshBasicMaterial({color:0x00e5ff, transparent:true, opacity:0.1, side:THREE.DoubleSide}));
padGlow.rotation.x = -Math.PI/2; padGlow.position.y = 0.015; scene.add(padGlow);

// Warning Stripes
const stripeM = new THREE.MeshBasicMaterial({color:0xffaa00});
for(let i=-6; i<=6; i++) {
  const stripe = new THREE.Mesh(new THREE.PlaneGeometry(0.8, 0.15), stripeM);
  stripe.rotation.x = -Math.PI/2; stripe.position.set(i*1.5, 0.02, 3.5); scene.add(stripe);
}

// Background Walls & Scaffolding
const wMat = new THREE.MeshStandardMaterial({color:0x080a10, roughness:0.9});
const backWall = new THREE.Mesh(new THREE.PlaneGeometry(40, 25), wMat);
backWall.position.set(0, 12.5, -12); scene.add(backWall);

const frameMat = new THREE.MeshStandardMaterial({color:0x222222, metalness:0.7, roughness:0.5});
// Vertical Pillars
[-4, 4].forEach(x => {
  const p = new THREE.Mesh(new THREE.BoxGeometry(0.6, 20, 0.6), frameMat);
  p.position.set(x, 10, -5); scene.add(p);
  const p2 = new THREE.Mesh(new THREE.BoxGeometry(0.4, 20, 0.4), frameMat);
  p2.position.set(x*1.5, 10, -11.5); scene.add(p2);
});
// Horizontal Catwalks
[4, 8, 12].forEach(y => {
  const cw = new THREE.Mesh(new THREE.BoxGeometry(12, 0.2, 1.5), frameMat);
  cw.position.set(0, y, -5.5); scene.add(cw);
});

// Overhead Volumetric Spotlight
const spotG = new THREE.ConeGeometry(3, 16, 32, 1, true);
const spotM = new THREE.MeshBasicMaterial({color:0xffffff, transparent:true, opacity:0.02, blending:THREE.AdditiveBlending, side:THREE.DoubleSide, depthWrite:false});
const spotlight = new THREE.Mesh(spotG, spotM);
spotlight.position.set(0, 8, 0); scene.add(spotlight);

/* ── ASSEMBLY LOGIC ── */
let isInstalling = false;
let installT = 0;
let installId = null;

function triggerInstall(id) {
  isInstalling = true; installT = 0; installId = id;
  Snd.play(400, 'sine', 0.8, 0.1, true); 
}

function finishInstall() {
  isInstalling = false;
  
  if(USE_CUSTOM_GLTF) {
     const chunkIndex = installId - 1;
     if(customModelChunks[chunkIndex]) {
         customModelChunks[chunkIndex].forEach(m => {
             m.visible = true;
         });
         fireSparksGLTF(customModelChunks[chunkIndex]);
     }
  }
  
  Snd.heavySnap();

  currentStage++; saveProgress(currentStage);
  if(currentStage > 7) setTimeout(activateSuit, 1200);
  renderUI();
}

function activateSuit() {
  isFullyAssembled = true;
  Snd.surge();
  const flash = document.getElementById('flash');
  if(flash) { flash.style.opacity = '1'; setTimeout(() => flash.style.opacity = '0', 800); }
  
  const g = document.getElementById('greeting'); 
  if(g) { g.classList.add('show'); setTimeout(() => g.classList.remove('show'), 6000); }
  
  const sDot = document.getElementById('sys-dot'); if(sDot) sDot.className = 'dot g';
  const sTxt = document.getElementById('sys-txt'); if(sTxt) { sTxt.style.color = 'var(--green)'; sTxt.textContent = 'ONLINE'; }
  const bMsg = document.getElementById('b-msg'); if(bMsg) bMsg.textContent = 'MANUAL CONTROL ENGAGED';
  const pCtrl = document.getElementById('panel-controls'); if(pCtrl) pCtrl.classList.add('unlocked');
  
  setAnim('idle'); 
}
if(currentStage > 7) { setTimeout(()=> {
  activateSuit(); 
  const g = document.getElementById('greeting'); if(g) g.classList.remove('show');
}, 1000); }

/* ── PARTICLES ── */
const ptG = new THREE.BufferGeometry(), ptC=200;
const ptP = new Float32Array(ptC*3), ptV = [];
for(let i=0;i<ptC;i++){ptP[i*3]=0;ptP[i*3+1]=0;ptP[i*3+2]=0; ptV.push(new THREE.Vector3());}
ptG.setAttribute('position', new THREE.BufferAttribute(ptP, 3));
const ptM = new THREE.PointsMaterial({color:0xffdd44, size:0.1, transparent:true, opacity:0, blending:THREE.AdditiveBlending});
const sparks = new THREE.Points(ptG, ptM); scene.add(sparks);

let sLife = 0;
function fireSparksGLTF(meshes) {
  if(!meshes || meshes.length === 0) return;
  let center = new THREE.Vector3();
  let count = 0;
  meshes.forEach(m => {
      let p = new THREE.Vector3();
      m.getWorldPosition(p);
      center.add(p); count++;
  });
  center.divideScalar(count);
  
  sparks.position.copy(center); ptM.opacity = 1; sLife = 1.0;
  for(let i=0;i<ptC;i++){
    ptV[i].set((Math.random()-0.5)*15, Math.random()*15, (Math.random()-0.5)*15);
    ptG.attributes.position.setXYZ(i, 0,0,0);
  }
}

/* ── INPUT & CAMERA ── */
window.addEventListener('keydown', e => { const k=e.key.toLowerCase(); if(keys.hasOwnProperty(k)) keys[k]=true; });
window.addEventListener('keyup', e => { const k=e.key.toLowerCase(); if(keys.hasOwnProperty(k)) keys[k]=false; });
window.addEventListener('mousemove', e => { mouseX = (e.clientX/innerWidth)*2-1; mouseY = -(e.clientY/innerHeight)*2+1; });

let cDrag=false, cRBtn=false, cPrev={x:0,y:0};
let sph={t:0.5, p:1.3, r:22}, tsph={t:0.5, p:1.3, r:22};
let pan=new THREE.Vector3(), tpan=new THREE.Vector3();

canvas.addEventListener('mousedown', e=>{cDrag=true; cRBtn=e.button===2; cPrev={x:e.clientX,y:e.clientY};});
canvas.addEventListener('contextmenu', e=>e.preventDefault());
window.addEventListener('mouseup', ()=>cDrag=false);
window.addEventListener('mousemove', e=>{
  if(!cDrag)return;
  const dx=e.clientX-cPrev.x, dy=e.clientY-cPrev.y; cPrev={x:e.clientX,y:e.clientY};
  if(!cRBtn){ tsph.t -= dx*0.005; tsph.p = Math.max(0.1, Math.min(Math.PI*0.9, tsph.p+dy*0.005)); }
  else { tpan.x -= dx*0.01; tpan.y += dy*0.01; }
});
canvas.addEventListener('wheel', e=>{ tsph.r = Math.max(5, Math.min(40, tsph.r+e.deltaY*0.03)); },{passive:true});

/* ── GLTF ANIMATION SYS ── */
let curAnim='idle';

window.setAnim = (n) => {
  if(!isFullyAssembled) return;
  document.querySelectorAll('.ab').forEach(b=>b.classList.remove('on'));
  const btn=document.getElementById('btn-'+n); if(btn)btn.classList.add('on');
  curAnim=n; 
  const animLabel = document.getElementById('lanim');
  if (animLabel) animLabel.textContent = n.toUpperCase();
  
  if (USE_CUSTOM_GLTF && mixer && gltfAnimations.length > 0) {
      mixer.stopAllAction();
      let clip = gltfAnimations.find(a => a.name.toLowerCase().includes(n)) || gltfAnimations[0];
      if(clip) mixer.clipAction(clip).play();
  }
}

/* ── MAIN LOOP ── */
renderUI();
let loadPct=0; const lbw=document.getElementById('lb'), lm=document.getElementById('lm');
const lInt=setInterval(()=>{
  loadPct+=Math.random()*15; if(loadPct>100)loadPct=100; lbw.style.width=loadPct+'%';
}, 80);

const clk = new THREE.Clock();

function tick(){
  requestAnimationFrame(tick);
  const dt=clk.getDelta(), t=clk.getElapsedTime();

  if(sLife > 0) {
    sLife -= dt*1.5; ptM.opacity = Math.max(0, sLife);
    const p = ptG.attributes.position;
    for(let i=0;i<ptC;i++){
      ptV[i].y -= dt*20; 
      p.setXYZ(i, p.getX(i)+ptV[i].x*dt, p.getY(i)+ptV[i].y*dt, p.getZ(i)+ptV[i].z*dt);
    }
    p.needsUpdate = true;
  }

  // Update Animation Mixer for Optimus Prime
  if(mixer) mixer.update(dt);

  // Assembly Flight Status
  if(isInstalling) {
      installT += dt * 1.5; 
      if(installT >= 1) finishInstall();
  }

  // Mobile Suit Walk Logic
  if(isFullyAssembled) {
    
    let dx=0, dz=0;
    let speed = keys.shift ? dt * 18 : dt * 7;
    
    if(keys.w) dz -= speed; if(keys.s) dz += speed;
    if(keys.a) dx -= speed; if(keys.d) dx += speed;

    if(dx!==0 || dz!==0) {
      robot.position.x += dx; robot.position.z += dz;
      tpan.copy(robot.position);
      const tgtA = Math.atan2(dx, dz);
      let diff = tgtA - robot.rotation.y;
      while(diff < -Math.PI) diff += Math.PI*2; while(diff > Math.PI) diff -= Math.PI*2;
      robot.rotation.y += diff * 0.15;

      if(curAnim !== 'walk' && curAnim !== 'run') setAnim(keys.shift ? 'run' : 'walk');
    } else {
      if (curAnim === 'walk' || curAnim === 'run') setAnim('idle');
    }
  }

  // Camera Update
  sph.t += (tsph.t - sph.t) * 0.08;
  sph.p += (tsph.p - sph.p) * 0.08;
  sph.r += (tsph.r - sph.r) * 0.05;
  pan.lerp(tpan, 0.08);
  cam.position.set(sph.r*Math.sin(sph.p)*Math.sin(sph.t)+pan.x, sph.r*Math.cos(sph.p)+2+pan.y, sph.r*Math.sin(sph.p)*Math.cos(sph.t)+pan.z);
  cam.lookAt(pan.x, 2+pan.y, pan.z);

  // HUD
  const el = Math.floor(t);
  const timeLabel = document.getElementById('ltime');
  if (timeLabel) timeLabel.textContent = String(Math.floor(el/60)).padStart(2,'0')+':'+String(el%60).padStart(2,'0');
  
  const tempLabel = document.getElementById('ltemp');
  if (tempLabel) tempLabel.textContent = (3200 + Math.sin(t) * 100).toFixed(0) + ' K';

  composer.render();
}
tick();

window.addEventListener('resize', () => {
  cam.aspect = innerWidth/innerHeight; cam.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight); composer.setSize(innerWidth, innerHeight);
});
</script>
</body>
</html>
